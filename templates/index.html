<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>EmotiBit Live Sensor Data</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
body {
  font-family: sans-serif;
  background: #f4f4f4;
  text-align: center;
  padding: 20px;
  margin: 0;
}
h1, h2 {
  margin: 15px 0;
}
.sensor-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(280px, 1fr));
  gap: 24px;
  align-items: stretch;
  justify-items: center;
  max-width: 1200px;
  margin: 0 auto;
}
.grid-span-2 {
  grid-column: 1 / -1;
}
.sensor-box {
  width: 100%;
  background: #fff;
  padding: 25px 40px;
  border-radius: 15px;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
  transition: all .3s;
  text-align: left;
}
.sensor-box h2 {
  margin: 0 0 12px 0;
  font-size: 1.9em;
}
.value {
  display: inline-block;
  margin-right: 25px;
  font-size: 22px;
  font-weight: 600;
  transition: color .3s, transform .3s;
}
.icon {
  font-size: 36px;
  color: #007bff;
  margin-right: 10px;
  vertical-align: middle;
}
.log-section {
  background: #fff;
  border-radius: 10px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 0 15px rgba(0,0,0,0.05);
  max-height: 300px;
  overflow-y: auto;
  text-align: left;
  width: 100%;
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}
#controls {
  margin: 22px 0 8px;
}
button {
  padding: 10px 20px;
  font-size: 16px;
  margin: 5px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background .3s;
}
button:hover {
  background-color: #ddd;
}
#startWalkBtn, #startBedBtn {
  background-color: #28a745;
  color: white;
}
#stopBtn, #downloadRawBtn, #downloadResampledBtn, #download5sResampledBtn, #download10sResampledBtn {
  background-color: #3f51b5;
  color: white;
  display: none;
}
#recordingStatus {
  font-weight: bold;
  color: green;
  margin-top: 10px;
}
.mode-controls {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  flex-wrap: wrap;
}
.toggle-btn {
  background-color: #f0f0f0;
  color: #333;
}
.toggle-btn.active {
  background-color: #28a745;
  color: #fff;
}
#modeStatus {
  font-weight: 600;
  color: #444;
  margin-left: 6px;
}
.heading-box {
  margin-top: 12px;
  padding: 10px 12px;
  border-radius: 10px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  display: inline-flex;
  gap: 10px;
  align-items: center;
}
.heading-deg {
  font-weight: 700;
  font-size: 20px;
}
.heading-dir {
  font-size: 16px;
  color: #444;
}
.compass {
  font-size: 20px;
}
.subnote {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}
@media (max-width: 900px) {
  .sensor-grid {
    grid-template-columns: 1fr;
  }
  .grid-span-2 {
    grid-column: 1 / -1;
  }
  .sensor-box {
    text-align: center;
  }
}
</style>
</head>
<body>
<h1>üì° EmotiBit Live Sensor Data</h1>
<div id="dashboard" class="sensor-grid">
  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: ACC + GYRO -->
  <div class="sensor-box">
    <h2><i class="fas fa-arrows-alt icon"></i> Accelerometer</h2>
    <div class="value" id="acc_x">X: -</div>
    <div class="value" id="acc_y">Y: -</div>
    <div class="value" id="acc_z">Z: -</div>
  </div>
  <div class="sensor-box">
    <h2><i class="fas fa-sync-alt icon"></i> Gyroscope</h2>
    <div class="value" id="gyro_x">X: -</div>
    <div class="value" id="gyro_y">Y: -</div>
    <div class="value" id="gyro_z">Z: -</div>
  </div>
  <!-- ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á: MAG (‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß) -->
  <div class="sensor-box grid-span-2">
    <h2><i class="fas fa-compass icon"></i> Magnetometer</h2>
    <div class="value" id="mag_x">X: -</div>
    <div class="value" id="mag_y">Y: -</div>
    <div class="value" id="mag_z">Z: -</div>
    <div style="margin-top:10px;">
      <button onclick="setMagBaseline()">Set MAG Baseline</button>
      <p id="baseline-status" class="subnote">Baseline ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</p>
    </div>
    <div class="mode-controls" aria-label="MAG baseline mode">
      <button id="modeX0Btn" class="toggle-btn" title="Xi/X0 = 1">Baseline: Xi/X0</button>
      <button id="modePrevBtn" class="toggle-btn" title="Xi/Xi-1 = 1">Baseline: Xi/Xi-1</button>
      <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î Xi/Xi-5 -->
      <button id="modePrev5Btn" class="toggle-btn" title="Xi/Xi-5 = 1">Baseline: Xi/Xi-5</button>
      <span id="modeStatus">‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: -</span>
    </div>
    <div class="heading-box">
      <span class="compass">üß≠</span>
      <span class="heading-deg" id="headingDeg">-.-¬∞</span>
      <span class="heading-dir" id="headingDir">(‡∏ó‡∏¥‡∏® -)</span>
    </div>
    <div class="subnote">* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏î‡∏¥‡∏ö ACC+MAG (‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡πÄ‡∏≠‡∏µ‡∏¢‡∏á); ‡∏ñ‡πâ‡∏≤ ACC ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ä‡∏î‡πÄ‡∏ä‡∏¢</div>
  </div>
</div>
<div id="controls">
  <button id="startWalkBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</button>
  <button id="startBedBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏∏‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡πÑ‡∏õ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥</button>
  <button id="stopBtn">‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & Download CSV</button>
  <button id="downloadRawBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏î‡∏¥‡∏ö</button>
  <button id="downloadResampledBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏µ‡πÅ‡∏ã‡∏°‡∏õ‡πå</button>
  <button id="download5sResampledBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏µ‡πÅ‡∏ã‡∏°‡∏õ‡πå 5s</button>
  <button id="download10sResampledBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏µ‡πÅ‡∏ã‡∏°‡∏õ‡πå 10s</button>
  <div id="recordingStatus"></div>
</div>
<h2>üö® Critical Sensor Logs</h2>
<div class="log-section">
  <h3>Accelerometer Logs</h3>
  <div id="acc-log"></div>
  <h3>Gyroscope Logs</h3>
  <div id="gyro-log"></div>
</div>
<script>
const socket = io();
const expectedSensors = ["ACC", "GYRO", "MAG"];
const expectedAxes = ["x", "y", "z"];
const logs = { ACC: [], GYRO: [] };
const startWalkBtn = document.getElementById("startWalkBtn");
const startBedBtn = document.getElementById("startBedBtn");
const stopBtn = document.getElementById("stopBtn");
const downloadRawBtn = document.getElementById("downloadRawBtn");
const downloadResampledBtn = document.getElementById("downloadResampledBtn");
const download5sResampledBtn = document.getElementById("download5sResampledBtn");
const download10sResampledBtn = document.getElementById("download10sResampledBtn");
const statusDiv = document.getElementById("recordingStatus");

// MAG mode controls
const modeX0Btn = document.getElementById('modeX0Btn');
const modePrevBtn = document.getElementById('modePrevBtn');
const modePrev5Btn = document.getElementById('modePrev5Btn');
const modeStatus = document.getElementById('modeStatus');

// Heading UI
const headingDegEl = document.getElementById('headingDeg');
const headingDirEl = document.getElementById('headingDir');

function setActiveModeUI(mode) {
  modeX0Btn.classList.toggle('active', mode === 'x0');
  modePrevBtn.classList.toggle('active', mode === 'prev');
  modePrev5Btn.classList.toggle('active', mode === 'prev5');
  modeStatus.textContent = `‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${mode}`;
}

// sync mode on load
socket.emit("get_mag_mode");
socket.on("mag_mode_status", (payload) => {
  if (!payload) return;
  if (payload.ok === false) {
    modeStatus.textContent = `‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${payload.mode || '-'} (error: ${payload.error || 'invalid'})`;
    return;
  }
  if (payload.mode) setActiveModeUI(payload.mode);
});

// switch mode
modeX0Btn.onclick = () => {
  modeStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î...";
  socket.emit("set_mag_mode", { mode: "x0" });
};
modePrevBtn.onclick = () => {
  modeStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î...";
  socket.emit("set_mag_mode", { mode: "prev" });
};
// ‡∏õ‡∏∏‡πà‡∏° Xi/Xi-5
modePrev5Btn.onclick = () => {
  modeStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î...";
  socket.emit("set_mag_mode", { mode: "prev5" });
};

function resetUI() {
  startWalkBtn.disabled = false;
  startWalkBtn.style.display = 'inline-block';
  startBedBtn.disabled = false;
  startBedBtn.style.display = 'inline-block';
  stopBtn.disabled = true;
  stopBtn.style.display = 'none';
  downloadRawBtn.style.display = 'none';
  downloadResampledBtn.style.display = 'none';
  download5sResampledBtn.style.display = 'none';
  download10sResampledBtn.style.display = 'none';
  statusDiv.textContent = '';
  statusDiv.style.color = '';
}

startWalkBtn.onclick = () => {
  socket.emit("start_recording", { activity: "walk" });
  startWalkBtn.disabled = true;
  startWalkBtn.style.display = 'none';
  startBedBtn.disabled = true;
  startBedBtn.style.display = 'none';
  stopBtn.disabled = false;
  stopBtn.style.display = 'inline-block';
  downloadRawBtn.style.display = 'none';
  downloadResampledBtn.style.display = 'none';
  download5sResampledBtn.style.display = 'none';
  download10sResampledBtn.style.display = 'none';
  statusDiv.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô...";
  statusDiv.style.color = "green";
};

startBedBtn.onclick = () => {
  socket.emit("start_recording", { activity: "bed to toilet" });
  startWalkBtn.disabled = true;
  startWalkBtn.style.display = 'none';
  startBedBtn.disabled = true;
  startBedBtn.style.display = 'none';
  stopBtn.disabled = false;
  stopBtn.style.display = 'inline-block';
  downloadRawBtn.style.display = 'none';
  downloadResampledBtn.style.display = 'none';
  download5sResampledBtn.style.display = 'none';
  download10sResampledBtn.style.display = 'none';
  statusDiv.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏∏‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡πÑ‡∏õ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥...";
  statusDiv.style.color = "green";
};

// ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≠ stop
let stopWaitTimer = null;
stopBtn.onclick = () => {
  socket.emit("stop_recording");
  stopBtn.disabled = true;
  statusDiv.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
  statusDiv.style.color = "red";
  if (stopWaitTimer) clearTimeout(stopWaitTimer);
  stopWaitTimer = setTimeout(() => {
    statusDiv.textContent = "‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
    statusDiv.style.color = "orange";
  }, 8000);
};

// ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ö‡∏≠‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
socket.on("recording_stopped", (response) => {
  if (stopWaitTimer) {
    clearTimeout(stopWaitTimer);
    stopWaitTimer = null;
  }
  if (response.status === "success") {
    statusDiv.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå";
    statusDiv.style.color = "blue";
    stopBtn.style.display = 'none';
    downloadRawBtn.style.display = 'inline-block';
    downloadResampledBtn.style.display = 'inline-block';
    download5sResampledBtn.style.display = 'inline-block';
    download10sResampledBtn.style.display = 'inline-block';
    downloadRawBtn.onclick = () => window.location.href = response.download_urls.raw;
    downloadResampledBtn.onclick = () => window.location.href = response.download_urls.resampled;
    download5sResampledBtn.onclick = () => window.location.href = response.download_urls["5s_resampled"];
    download10sResampledBtn.onclick = () => window.location.href = response.download_urls["10s_resampled"];
  } else {
    statusDiv.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${response.message || ''}`;
    statusDiv.style.color = "red";
    stopBtn.style.display = 'none';
    downloadRawBtn.style.display = 'none';
    downloadResampledBtn.style.display = 'none';
    download5sResampledBtn.style.display = 'none';
    download10sResampledBtn.style.display = 'none';
    startWalkBtn.disabled = false;
    startWalkBtn.style.display = 'inline-block';
    startBedBtn.disabled = false;
    startBedBtn.style.display = 'inline-block';
  }
});

function addLog(sensor, x, y, z) {
  const now = new Intl.DateTimeFormat('th-TH', {
    timeZone: 'Asia/Bangkok',
    dateStyle: 'short',
    timeStyle: 'medium'
  }).format(new Date());
  const entry = document.createElement("div");
  entry.innerHTML = `<strong>[${now}]</strong> X: <span style="color:red">${x.toFixed(2)}</span>, Y: <span style="color:red">${y.toFixed(2)}</span>, Z: <span style="color:red">${z.toFixed(2)}</span>`;
  const logContainer = document.getElementById(sensor.toLowerCase() + "-log");
  logContainer.prepend(entry);
  logs[sensor].unshift(entry);
  if (logs[sensor].length > 10) {
    const removed = logs[sensor].pop();
    removed.remove();
  }
}

socket.on("sensor_data", (data) => {
  for (const sensor of expectedSensors) {
    const sensorData = data[sensor];
    if (!sensorData) continue;
    let abnormal = false;
    const values = {};
    for (const axis of expectedAxes) {
      const value = sensorData[axis];
      if (value === undefined) continue;
      const elementId = `${sensor.toLowerCase()}_${axis}`;
      const element = document.getElementById(elementId);
      if (!element) continue;
      const floatValue = parseFloat(value);
      values[axis] = floatValue;
      const text = `${axis.toUpperCase()}: ${floatValue.toFixed(4)}`;
      if (element.textContent !== text) {
        element.textContent = text;
        let isCritical = false;
        if (sensor === "ACC" && Math.abs(floatValue) > 1.5) isCritical = true;
        if (sensor === "GYRO" && Math.abs(floatValue) > 300.0) isCritical = true;
        element.style.color = isCritical ? "red" : "#3de505";
        element.style.transform = isCritical ? "scale(1.1)" : "";
        setTimeout(() => {
          element.style.color = "";
          element.style.transform = "";
        }, 200);
        if (isCritical) abnormal = true;
      }
    }
    if (abnormal && (sensor === "ACC" || sensor === "GYRO")) {
      addLog(sensor, values.x, values.y, values.z);
    }
  }
});

// ‡∏£‡∏±‡∏ö heading ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
socket.on("heading_data", (payload) => {
  if (!payload) return;
  if (typeof payload.deg === 'number') headingDegEl.textContent = `${payload.deg.toFixed(1)}¬∞`;
  if (payload.dir) headingDirEl.textContent = `(${payload.dir})`;
});

function setMagBaseline() {
  socket.emit("set_mag_baseline");
  document.getElementById("baseline-status").innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ baseline...";
}

socket.on("mag_baseline_status", (baseline) => {
  document.getElementById("baseline-status").innerText = `Baseline ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß: x=${baseline.x.toFixed(2)}, y=${baseline.y.toFixed(2)}, z=${baseline.z.toFixed(2)}`;
});

window.addEventListener('load', resetUI);
window.addEventListener('popstate', resetUI);
</script>
</body>
</html> <!-- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ index -->
